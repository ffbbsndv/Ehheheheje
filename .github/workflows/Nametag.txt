local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Head = Character:WaitForChild("Head")

local nametagSonix = {
    { name = "─「 KRYSTAL DANCE 」─", color = Color3.fromRGB(255, 100, 255), weight = 10, rare = true, version = "─1 in 1─" },
    { name = "─「 VOID SHADE 」─", color = Color3.fromRGB(100, 100, 255), weight = 7.5, rare = true, version = "─1 in 10─" },
    { name = "─「 NEON DRIFT 」─", color = Color3.fromRGB(0, 255, 255), weight = 5, rare = true, version = "─1 in 25─" },
    { name = "─「 COSMIC PULSE 」─", color = Color3.fromRGB(90, 0, 160), weight = 2.5, rare = true, version = "─1 in 50─" },
    { name = "─「 STARFADE 」─", color = Color3.fromRGB(20, 20, 20), weight = 1, rare = true, version = "─1 in 100─" }
}

local function GetSonixChildren()
    local total = 0
    for _, tag in ipairs(nametagSonix) do total += tag.weight end
    local pick = math.random() * total
    local sum = 0
    for _, tag in ipairs(nametagSonix) do
        sum += tag.weight
        if pick <= sum then return tag end
    end
end

local function SonixHaloSkedaddle(char, color)
    local head = char:FindFirstChild("Head")
    if not head then return end

    local halo = Instance.new("Part")
    halo.Name = "SonixHalo"
    halo.Size = Vector3.new(2, 2, 2)
    halo.Anchored = true
    halo.CanCollide = false
    halo.Material = Enum.Material.Neon
    halo.Transparency = 0.2
    halo.Color = color
    halo.Parent = workspace

    local mesh = Instance.new("SpecialMesh", halo)
    mesh.MeshId = "rbxassetid://3270017"
    mesh.Scale = Vector3.new(1.5, 1.5, 1.5)

    local light = Instance.new("PointLight", halo)
    light.Brightness = 4
    light.Range = 10
    light.Color = color

    RunService.RenderStepped:Connect(function()
        if halo and halo.Parent and head then
            halo.CFrame = CFrame.new(head.Position + Vector3.new(0, 1.35, 0)) * CFrame.Angles(math.rad(90), 0, 0)
        end
    end)
end

local function strokeGradient(label, color)
    local stroke = Instance.new("UIStroke", label)
    stroke.Thickness = 1
    stroke.Color = Color3.new(1, 1, 1)
    stroke.LineJoinMode = Enum.LineJoinMode.Miter
    local grad = Instance.new("UIGradient", stroke)
    grad.Rotation = 85
    grad.Offset = Vector2.new(-1, 0)
    grad.Color = color
end

local function createTagGui(player, tagData)
    if not player.Character or not player.Character:FindFirstChild("Head") then return end
    local head = player.Character.Head

    if head:FindFirstChild("SonixTagGui") then return end

    local board = Instance.new("BillboardGui", head)
    board.Name = "SonixTagGui"
    board.Size = UDim2.new(0, 100, 0, 40)
    board.StudsOffset = Vector3.new(0, 5, 0)
    board.Adornee = head
    board.AlwaysOnTop = true
    board.MaxDistance = 25

    local top = Instance.new("TextLabel", board)
    top.Text = tagData.version
    top.Font = Enum.Font.Sarpanch
    top.TextSize = 30
    top.TextColor3 = Color3.new(0, 0, 0)
    top.BackgroundTransparency = 1
    top.Position = UDim2.new(0.5, -50, 1, -15)
    top.Size = UDim2.new(1, 0, 1, 0)
    strokeGradient(top, ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.new(1, 1, 1)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(100, 100, 100)),
        ColorSequenceKeypoint.new(1, Color3.new(1, 1, 1))
    })

    local main = Instance.new("TextLabel", board)
    main.Text = tagData.name
    main.Font = Enum.Font.Sarpanch
    main.TextSize = 50
    main.TextColor3 = Color3.new(0, 0, 0)
    main.BackgroundTransparency = 1
    main.Size = UDim2.new(1, 0, 1, 0)
    strokeGradient(main, ColorSequence.new{
        ColorSequenceKeypoint.new(0, tagData.color),
        ColorSequenceKeypoint.new(1, Color3.new(1, 1, 1))
    })
end

local tag = GetSonixChildren()
createTagGui(LocalPlayer, tag)
if tag.rare then
    SonixHaloSkedaddle(Character, tag.color)
end

local tagTable = {}
tagTable[LocalPlayer.Name] = tag

Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(char)
        task.wait(1)
        -- If they've injected the same script, this variable will exist
        task.spawn(function()
            while true do
                local head = char:FindFirstChild("Head")
                if head and not head:FindFirstChild("SonixTagGui") and tagTable[player.Name] then
                    local theirTag = tagTable[player.Name]
                    createTagGui(player, theirTag)
                    if theirTag.rare then
                        SonixHaloSkedaddle(char, theirTag.color)
                    end
                end
                task.wait(2)
            end
        end)
    end)
end)

RunService.RenderStepped:Connect(function()
    for _, other in pairs(Players:GetPlayers()) do
        if other ~= LocalPlayer and other.Character and other.Character:FindFirstChild("Head") then
            local head = other.Character.Head
            -- Check for tag consistency
            local theirGui = head:FindFirstChild("SonixTagGui")
            if theirGui then
                local label = theirGui:FindFirstChildOfClass("TextLabel")
                if label and label.Text ~= tag.name then
                    label.Text = "[MODIFIED] " .. label.Text
                    label.TextColor3 = Color3.fromRGB(255, 0, 0)
                end
            end
        end
    end
end)
